# オセロゲーム テスト仕様書

## 概要
本仕様書は、t-wadaのTDD（Test-Driven Development）の原則に基づき、オセロゲームの各コンポーネントに対するテスト項目を定義します。

## TDDの基本原則

### 1. RED-GREEN-REFACTORサイクル
- **RED**: 失敗するテストを最初に書く
- **GREEN**: テストを通す最小限のコードを書く
- **REFACTOR**: コードを改善する

### 2. AAAパターン
- **Arrange**: テストの準備（前提条件の設定）
- **Act**: テスト対象の実行
- **Assert**: 期待結果の検証

### 3. テストの特性（FIRST原則）
- **Fast**: 高速に実行できる
- **Independent**: 他のテストに依存しない
- **Repeatable**: 何度でも同じ結果が得られる
- **Self-validating**: 自動で成功/失敗が判定できる
- **Timely**: プロダクトコードと同時に書く

## テスト対象クラスと項目

### 1. Board クラス（`src/game/board.py`）

#### 1.1 初期化のテスト
```python
def test_初期化時のボードサイズ():
    """8x8のボードが生成されることを確認"""

def test_初期配置の正確性():
    """中央4マスに白黒が交互に配置されることを確認"""
    # (3,3): 白, (3,4): 黒, (4,3): 黒, (4,4): 白
```

#### 1.2 基本操作のテスト
```python
def test_有効な位置の判定():
    """0-7の範囲内が有効と判定されることを確認"""

def test_無効な位置の判定():
    """範囲外の座標が無効と判定されることを確認"""

def test_空のセルの判定():
    """石が置かれていないセルを正しく判定"""

def test_石の配置と取得():
    """set_cellとget_cellの動作確認"""
```

#### 1.3 ゲームロジックのテスト
```python
def test_相手プレイヤーの取得():
    """黒→白、白→黒の切り替えを確認"""

def test_単一方向のひっくり返し():
    """1方向のみの石のひっくり返しを確認"""

def test_複数方向のひっくり返し():
    """複数方向同時の石のひっくり返しを確認"""

def test_ひっくり返せない場合():
    """隣接する相手の石がない場合の処理"""

def test_有効手の判定_通常():
    """通常の有効手判定"""

def test_有効手の判定_角():
    """角への配置の有効性"""

def test_有効手の判定_端():
    """端への配置の有効性"""
```

#### 1.4 ゲーム状態のテスト
```python
def test_石のカウント():
    """黒白空のカウントが正確であることを確認"""

def test_ボード満杯の判定():
    """全マス埋まった状態の判定"""

def test_有効手リストの取得():
    """現在のプレイヤーの全有効手を取得"""

def test_ボードのコピー():
    """深いコピーが作成されることを確認"""
```

### 2. Game クラス（`src/game/game.py`）

#### 2.1 ゲーム開始のテスト
```python
def test_ゲーム初期状態():
    """初期プレイヤーが黒であることを確認"""

def test_初期有効手():
    """黒の初期有効手が4つであることを確認"""
```

#### 2.2 ゲーム進行のテスト
```python
def test_正常な手の実行():
    """有効な手が正しく実行されることを確認"""

def test_無効な手の拒否():
    """無効な手が拒否されることを確認"""

def test_ターン切り替え():
    """手番が正しく切り替わることを確認"""

def test_パス処理_片方():
    """片方のプレイヤーがパスする場合の処理"""

def test_パス処理_連続():
    """両プレイヤーが連続パスでゲーム終了"""

def test_履歴の記録():
    """手の履歴が正しく記録されることを確認"""
```

#### 2.3 ゲーム終了のテスト
```python
def test_ゲーム終了判定_満杯():
    """ボード満杯でゲーム終了と判定"""

def test_ゲーム終了判定_有効手なし():
    """両者有効手なしでゲーム終了と判定"""

def test_勝者判定_黒勝利():
    """黒が多い場合の勝者判定"""

def test_勝者判定_白勝利():
    """白が多い場合の勝者判定"""

def test_勝者判定_引き分け():
    """同数の場合の引き分け判定"""
```

#### 2.4 特殊操作のテスト
```python
def test_アンドゥ_単一():
    """1手戻しの動作確認"""

def test_アンドゥ_複数():
    """複数手戻しの動作確認"""

def test_アンドゥ_履歴なし():
    """履歴がない場合のアンドゥ処理"""

def test_リセット():
    """ゲームの完全リセット確認"""
```

### 3. AI クラス（`src/game/ai.py`）

#### 3.1 難易度別動作のテスト
```python
def test_easy_ランダム選択():
    """Easyモードがランダムに手を選ぶことを確認"""

def test_medium_最大獲得():
    """Mediumモードが最大石数を獲得する手を選ぶことを確認"""

def test_hard_戦略的選択():
    """Hardモードが評価関数に基づく手を選ぶことを確認"""
```

#### 3.2 評価関数のテスト
```python
def test_角の評価():
    """角の石が高評価されることを確認"""

def test_辺の評価():
    """辺の石が中程度の評価を受けることを確認"""

def test_危険位置の評価():
    """X打ち・C打ちが低評価されることを確認"""

def test_機動力の評価():
    """相手の有効手数を考慮した評価"""
```

#### 3.3 Minimaxアルゴリズムのテスト
```python
def test_minimax_終端状態():
    """ゲーム終了状態での評価値計算"""

def test_minimax_1手読み():
    """深さ1での最適手選択"""

def test_minimax_複数手読み():
    """深さ3以上での最適手選択"""

def test_alphabeta_枝刈り():
    """アルファベータ法による枝刈りの動作"""
```

#### 3.4 特殊ケースのテスト
```python
def test_有効手なしの処理():
    """有効手がない場合のNone返却"""

def test_単一有効手():
    """有効手が1つしかない場合の処理"""

def test_完全ゲーム():
    """AI同士の対戦が正常終了することを確認"""
```

## テストフィクスチャ

### 共通フィクスチャ（`conftest.py`）
```python
@pytest.fixture
def empty_board():
    """空のボードを返すフィクスチャ"""

@pytest.fixture
def initial_board():
    """初期配置のボードを返すフィクスチャ"""

@pytest.fixture
def mid_game_board():
    """中盤の典型的な盤面を返すフィクスチャ"""

@pytest.fixture
def end_game_board():
    """終盤の典型的な盤面を返すフィクスチャ"""

@pytest.fixture
def game_with_history():
    """履歴付きのゲームインスタンスを返すフィクスチャ"""
```

## パラメータ化テスト

### 境界値テスト
```python
@pytest.mark.parametrize("row,col,expected", [
    (0, 0, True),   # 左上角
    (0, 7, True),   # 右上角
    (7, 0, True),   # 左下角
    (7, 7, True),   # 右下角
    (-1, 0, False), # 範囲外
    (8, 0, False),  # 範囲外
])
def test_位置の有効性(row, col, expected):
    """境界値での位置判定テスト"""
```

### 方向別テスト
```python
@pytest.mark.parametrize("direction", [
    (-1, -1), # 左上
    (-1, 0),  # 上
    (-1, 1),  # 右上
    (0, -1),  # 左
    (0, 1),   # 右
    (1, -1),  # 左下
    (1, 0),   # 下
    (1, 1),   # 右下
])
def test_各方向のひっくり返し(direction):
    """8方向それぞれのひっくり返しテスト"""
```

## カバレッジ目標

- **ライン カバレッジ**: 90%以上
- **ブランチ カバレッジ**: 85%以上
- **関数 カバレッジ**: 100%

## テスト実行方法

### 全テスト実行
```bash
pytest tests/
```

### カバレッジ付き実行
```bash
pytest tests/ --cov=src --cov-report=html
```

### 特定テストの実行
```bash
pytest tests/test_board.py::test_初期配置の正確性
```

### マーカー付きテスト
```bash
# 高速テストのみ
pytest -m fast

# 統合テストのみ
pytest -m integration
```

## テストの品質基準

1. **独立性**: 各テストは他のテストに依存しない
2. **再現性**: 実行順序や環境に関わらず同じ結果
3. **明確性**: テスト名から意図が明確
4. **単一責任**: 1つのテストで1つの振る舞いを検証
5. **高速性**: 単体テストは100ms以内で完了

## 継続的インテグレーション

GitHub Actionsでの自動テスト実行:
- プッシュ時に全テスト実行
- PRマージ前にカバレッジチェック
- 失敗時は自動通知

## 今後の拡張

- プロパティベーステスト（Hypothesis）の導入
- パフォーマンステストの追加
- E2Eテストの実装（Playwright）
- ミューテーションテストの導入